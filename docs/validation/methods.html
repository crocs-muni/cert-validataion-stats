<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1" />
<meta name="generator" content="pdoc 0.8.1" />
<title>cevast.validation.methods API documentation</title>
<meta name="description" content="This module provides various certificate validation methods â€¦" />
<link href='https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.0/normalize.min.css' rel='stylesheet'>
<link href='https://cdnjs.cloudflare.com/ajax/libs/10up-sanitize.css/8.0.0/sanitize.min.css' rel='stylesheet'>
<link href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css" rel="stylesheet">
<style>.flex{display:flex !important}body{line-height:1.5em}#content{padding:20px}#sidebar{padding:30px;overflow:hidden}#sidebar > *:last-child{margin-bottom:2cm}.http-server-breadcrumbs{font-size:130%;margin:0 0 15px 0}#footer{font-size:.75em;padding:5px 30px;border-top:1px solid #ddd;text-align:right}#footer p{margin:0 0 0 1em;display:inline-block}#footer p:last-child{margin-right:30px}h1,h2,h3,h4,h5{font-weight:300}h1{font-size:2.5em;line-height:1.1em}h2{font-size:1.75em;margin:1em 0 .50em 0}h3{font-size:1.4em;margin:25px 0 10px 0}h4{margin:0;font-size:105%}a{color:#058;text-decoration:none;transition:color .3s ease-in-out}a:hover{color:#e82}.title code{font-weight:bold}h2[id^="header-"]{margin-top:2em}.ident{color:#900}pre code{background:#f8f8f8;font-size:.8em;line-height:1.4em}code{background:#f2f2f1;padding:1px 4px;overflow-wrap:break-word}h1 code{background:transparent}pre{background:#f8f8f8;border:0;border-top:1px solid #ccc;border-bottom:1px solid #ccc;margin:1em 0;padding:1ex}#http-server-module-list{display:flex;flex-flow:column}#http-server-module-list div{display:flex}#http-server-module-list dt{min-width:10%}#http-server-module-list p{margin-top:0}.toc ul,#index{list-style-type:none;margin:0;padding:0}#index code{background:transparent}#index h3{border-bottom:1px solid #ddd}#index ul{padding:0}#index h4{margin-top:.6em;font-weight:bold}@media (min-width:200ex){#index .two-column{column-count:2}}@media (min-width:300ex){#index .two-column{column-count:3}}dl{margin-bottom:2em}dl dl:last-child{margin-bottom:4em}dd{margin:0 0 1em 3em}#header-classes + dl > dd{margin-bottom:3em}dd dd{margin-left:2em}dd p{margin:10px 0}.name{background:#eee;font-weight:bold;font-size:.85em;padding:5px 10px;display:inline-block;min-width:40%}.name:hover{background:#e0e0e0}.name > span:first-child{white-space:nowrap}.name.class > span:nth-child(2){margin-left:.4em}.inherited{color:#999;border-left:5px solid #eee;padding-left:1em}.inheritance em{font-style:normal;font-weight:bold}.desc h2{font-weight:400;font-size:1.25em}.desc h3{font-size:1em}.desc dt code{background:inherit}.source summary,.git-link-div{color:#666;text-align:right;font-weight:400;font-size:.8em;text-transform:uppercase}.source summary > *{white-space:nowrap;cursor:pointer}.git-link{color:inherit;margin-left:1em}.source pre{max-height:500px;overflow:auto;margin:0}.source pre code{font-size:12px;overflow:visible}.hlist{list-style:none}.hlist li{display:inline}.hlist li:after{content:',\2002'}.hlist li:last-child:after{content:none}.hlist .hlist{display:inline;padding-left:1em}img{max-width:100%}.admonition{padding:.1em .5em;margin-bottom:1em}.admonition-title{font-weight:bold}.admonition.note,.admonition.info,.admonition.important{background:#aef}.admonition.todo,.admonition.versionadded,.admonition.tip,.admonition.hint{background:#dfd}.admonition.warning,.admonition.versionchanged,.admonition.deprecated{background:#fd4}.admonition.error,.admonition.danger,.admonition.caution{background:lightpink}</style>
<style media="screen and (min-width: 700px)">@media screen and (min-width:700px){#sidebar{width:30%;height:100vh;overflow:auto;position:sticky;top:0}#content{width:70%;max-width:100ch;padding:3em 4em;border-left:1px solid #ddd}pre code{font-size:1em}.item .name{font-size:1em}main{display:flex;flex-direction:row-reverse;justify-content:flex-end}.toc ul ul,#index ul{padding-left:1.5em}.toc > ul > li{margin-top:.5em}}</style>
<style media="print">@media print{#sidebar h1{page-break-before:always}.source{display:none}}@media print{*{background:transparent !important;color:#000 !important;box-shadow:none !important;text-shadow:none !important}a[href]:after{content:" (" attr(href) ")";font-size:90%}a[href][title]:after{content:none}abbr[title]:after{content:" (" attr(title) ")"}.ir a:after,a[href^="javascript:"]:after,a[href^="#"]:after{content:""}pre,blockquote{border:1px solid #999;page-break-inside:avoid}thead{display:table-header-group}tr,img{page-break-inside:avoid}img{max-width:100% !important}@page{margin:0.5cm}p,h2,h3{orphans:3;widows:3}h1,h2,h3,h4,h5,h6{page-break-after:avoid}}</style>
</head>
<body>
<main>
<article id="content">
<header>
<h1 class="title">Module <code>cevast.validation.methods</code></h1>
</header>
<section id="section-intro">
<p>This module provides various certificate validation methods.</p>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>Each method accepts a single argument &ndash; list with cetificates file paths.
List should start with server certificate, followed by intermediates certificates
and end with trusted CA certificate.</p>
</div>
<p>To add an additional validation method, register the method under its name to global
variable METHODS in 'MODULE INITIALIZATION' section.</p>
<p>Module can be imported and used as a library. Import-safe functions should be used
to get validation method by name or get all the available methods:
- show()
- return tuple with all available method names
- get_all()
- return tuple with all available methods
- get(name)
- return methody with given name</p>
<p>Module can also be run as a standalone script with following usage:
python3 ./methods
- prints all available method names
python3 ./methods c1 c2 cN
- prints validation results from all available methods,
args c1-cN are provided to validation method as a chain that
starts with server certificate and ends with CA</p>
<div class="admonition todo">
<p class="admonition-title">TODO</p>
<p>Maybe would be better to analyse the certs before validation to identify CAs
and intermediates (validation would be better then)</p>
</div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">&#34;&#34;&#34;
This module provides various certificate validation methods.

.. important::
   Each method accepts a single argument -- list with cetificates file paths.
   List should start with server certificate, followed by intermediates certificates
   and end with trusted CA certificate.

To add an additional validation method, register the method under its name to global
variable METHODS in &#39;MODULE INITIALIZATION&#39; section.

Module can be imported and used as a library. Import-safe functions should be used
to get validation method by name or get all the available methods:
  - show()     - return tuple with all available method names
  - get_all()  - return tuple with all available methods
  - get(name)  - return methody with given name

Module can also be run as a standalone script with following usage:
    python3 ./methods           - prints all available method names
    python3 ./methods c1 c2 cN  - prints validation results from all available methods,
                                  args c1-cN are provided to validation method as a chain that
                                  starts with server certificate and ends with CA

.. todo::
   Maybe would be better to analyse the certs before validation to identify CAs
   and intermediates (validation would be better then)
&#34;&#34;&#34;

import sys
import os
import re
import logging
import subprocess
from collections import OrderedDict


log = logging.getLogger(__name__)

# global dictionary hodling all available validation methods in this module under usage name
METHODS = OrderedDict()

OK = &#34;0&#34;
UNKNOWN = &#34;XX&#34;


def is_tool_available(name):
    &#34;&#34;&#34;Check if the tool is installed and available on the system.&#34;&#34;&#34;
    try:
        subprocess.Popen([name], stdout=subprocess.DEVNULL, stderr=subprocess.DEVNULL)
    except OSError as err:
        if err.errno == os.errno.ENOENT:
            return False
    return True


def get_all():
    &#34;&#34;&#34;Get all available validation methods.&#34;&#34;&#34;
    return tuple(METHODS.values())


def get(name: str):
    &#34;&#34;&#34;Get validation method by name.&#34;&#34;&#34;
    return METHODS.get(name, None)


def show():
    &#34;&#34;&#34;Show available validation methods.&#34;&#34;&#34;
    return tuple(METHODS.keys())


def _cl_open_ssl(chain: list) -&gt; str:
    &#34;&#34;&#34;Validate SSL Certificate chain via command line openssl. Return result code.&#34;&#34;&#34;
    try:
        inter = []
        server = chain[0]
        if len(chain) == 2:
            inter = (&#39;--CAfile&#39;, chain[1])
        elif len(chain) &gt; 2:
            inter = [v for elt in chain[1:] for v in (&#39;-untrusted&#39;, elt)]
        # TODO check if only untrusted really works
        # openssl verify -show_chain -untrusted int.pem -untrusted int2.pem server.pem
        # openssl verify -show_chain --CAfile ca.pem server.pem
        subprocess.check_output([&#34;openssl&#34;, &#34;verify&#34;, &#34;-show_chain&#34;, *inter, server], stderr=subprocess.STDOUT)
        return OK
    except subprocess.CalledProcessError as err:
        # print(e.cmd)
        match_object = re.search(r&#39;\nerror (\d+)&#39;, err.output.decode(encoding=&#39;utf-8&#39;))
        if match_object:
            return match_object.group(1)
        log.exception(&#34;Validation failed&#34;)
        return UNKNOWN


def _PyOpenSSL(chain: list) -&gt; str:
    &#34;&#34;&#34;Validate SSL Certificate chain using python OpenSSL library. Return result code.&#34;&#34;&#34;
    inter = []
    server = chain[0]
    if len(chain) &gt; 1:
        inter = chain[1:]
    try:
        # Load the server certificate
        with open(server) as cert_file:
            certificate = crypto.load_certificate(crypto.FILETYPE_PEM, cert_file.read())
        # Create a certificate store and add trusted certs
        store = crypto.X509Store()
        for cert in inter:
            with open(cert) as cert_file:
                int_certificate = crypto.load_certificate(crypto.FILETYPE_PEM, cert_file.read())
                store.add_cert(int_certificate)
        # Create a certificate context using the store and the server certificate
        store_ctx = crypto.X509StoreContext(store, certificate)
        # Verify the certificate, returns None if it can validate the certificate
        store_ctx.verify_certificate()

        return OK
    except crypto.X509StoreContextError as err:
        return str(err.args[0][0])
    except crypto.Error:
        log.exception(&#34;Validation failed&#34;)
        return UNKNOWN


def _botan(chain: list) -&gt; str:
    &#34;&#34;&#34;Validate SSL Certificate chain using Botan library. Return result code.&#34;&#34;&#34;
    inter = []
    cacert = None
    server = chain[0]
    if len(chain) == 2:
        cacert = chain[-1]
    elif len(chain) &gt; 2:
        cacert = chain[-1]
        inter = chain[1:-1]
    try:
        # Load the server certificate
        server = botan.X509Cert(server)
        # Load untrusted subauthorities or set to None
        inter = [botan.X509Cert(i) for i in inter] if inter else None
        # Load CA cert or set to None
        cacert = [botan.X509Cert(cacert)] if cacert else None
        # Verify the certificate
        # Returns 0 if validation was successful, returns a positive error code if the validation was unsuccesful
        code = server.verify(intermediates=inter, trusted=cacert)
        if code != 0:
            log.debug(botan.X509Cert.validation_status(code))
        return code
    except botan.BotanException:
        log.exception(&#34;Validation failed&#34;)
        return UNKNOWN


# -----------   MODULE INITIALIZATION   -------------------------
# try to load command-line openssl
log.info(&#34;Loading cli openssl&#34;)
if is_tool_available(&#34;openssl&#34;):
    METHODS[&#39;openssl&#39;] = _cl_open_ssl

# try to load PyOpenSSL
log.info(&#34;Loading PyOpenSSL&#34;)
try:
    from OpenSSL import crypto  # pylint: disable=E0401

    METHODS[&#39;pyopenssl&#39;] = _PyOpenSSL
except ModuleNotFoundError:
    log.exception(&#34;PyOpenSSL failed to import - check if installed&#34;)

# try to load Botan
log.info(&#34;Loading Botan&#34;)
try:
    import botan2 as botan  # pylint: disable=E0401

    METHODS[&#39;botan&#39;] = _botan
except ModuleNotFoundError:
    log.exception(&#34;Botan failed to import - check if installed&#34;)
except Exception:
    log.exception(&#34;Botan failed to initialized - check if library is installed properly&#34;)


if __name__ == &#34;__main__&#34;:
    if len(sys.argv) &lt;= 1:
        print(show())
    else:
        for func in get_all():
            print(func(sys.argv[1:]))</code></pre>
</details>
</section>
<section>
</section>
<section>
</section>
<section>
<h2 class="section-title" id="header-functions">Functions</h2>
<dl>
<dt id="cevast.validation.methods.get"><code class="name flex">
<span>def <span class="ident">get</span></span>(<span>name:Â str)</span>
</code></dt>
<dd>
<div class="desc"><p>Get validation method by name.</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def get(name: str):
    &#34;&#34;&#34;Get validation method by name.&#34;&#34;&#34;
    return METHODS.get(name, None)</code></pre>
</details>
</dd>
<dt id="cevast.validation.methods.get_all"><code class="name flex">
<span>def <span class="ident">get_all</span></span>(<span>)</span>
</code></dt>
<dd>
<div class="desc"><p>Get all available validation methods.</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def get_all():
    &#34;&#34;&#34;Get all available validation methods.&#34;&#34;&#34;
    return tuple(METHODS.values())</code></pre>
</details>
</dd>
<dt id="cevast.validation.methods.is_tool_available"><code class="name flex">
<span>def <span class="ident">is_tool_available</span></span>(<span>name)</span>
</code></dt>
<dd>
<div class="desc"><p>Check if the tool is installed and available on the system.</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def is_tool_available(name):
    &#34;&#34;&#34;Check if the tool is installed and available on the system.&#34;&#34;&#34;
    try:
        subprocess.Popen([name], stdout=subprocess.DEVNULL, stderr=subprocess.DEVNULL)
    except OSError as err:
        if err.errno == os.errno.ENOENT:
            return False
    return True</code></pre>
</details>
</dd>
<dt id="cevast.validation.methods.show"><code class="name flex">
<span>def <span class="ident">show</span></span>(<span>)</span>
</code></dt>
<dd>
<div class="desc"><p>Show available validation methods.</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def show():
    &#34;&#34;&#34;Show available validation methods.&#34;&#34;&#34;
    return tuple(METHODS.keys())</code></pre>
</details>
</dd>
</dl>
</section>
<section>
</section>
</article>
<nav id="sidebar">
<h1>Index</h1>
<div class="toc">
<ul></ul>
</div>
<ul id="index">
<li><h3>Super-module</h3>
<ul>
<li><code><a title="cevast.validation" href="index.html">cevast.validation</a></code></li>
</ul>
</li>
<li><h3><a href="#header-functions">Functions</a></h3>
<ul class="">
<li><code><a title="cevast.validation.methods.get" href="#cevast.validation.methods.get">get</a></code></li>
<li><code><a title="cevast.validation.methods.get_all" href="#cevast.validation.methods.get_all">get_all</a></code></li>
<li><code><a title="cevast.validation.methods.is_tool_available" href="#cevast.validation.methods.is_tool_available">is_tool_available</a></code></li>
<li><code><a title="cevast.validation.methods.show" href="#cevast.validation.methods.show">show</a></code></li>
</ul>
</li>
</ul>
</nav>
</main>
<footer id="footer">
<p>Generated by <a href="https://pdoc3.github.io/pdoc"><cite>pdoc</cite> 0.8.1</a>.</p>
</footer>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad()</script>
</body>
</html>